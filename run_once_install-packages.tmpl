#!/bin/sh

# Handy yes/no dialog to let the user make some decisions
dialog_yes_no() {
    echo -e "\n$1 (y/N)? "
    read answer
    if [ "$answer" != "${answer#[Yy]}" ] ;then
        return 0
    else
        return 1
    fi
}

# Install homebrew (ubuntu/debian only)
install_homebrew() {
    if dialog_yes_no "$1 cannot be installed with your default pasckage manager. Do you want to install homebrew"; then
        HOMEBREW=1
    else
        HOMEBREW=0
        return 1
    fi
    {{ if eq .chezmoi.osRelease.id "ubuntu" "debian" -}}
        sudo apt-get install build-essential curl file git
    {{ end -}}
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
}

# Install a package with homebrew
# If homebrew is not installed, ask the user if he wants to install it
brew_wrapper() {
    if command -v brew; then
        brew install $1
    elif [ -f /home/linuxbrew/.linuxbrew/bin/brew ]; then
        /home/linuxbrew/.linuxbrew/bin/brew install $1
    elif [ -f $HOME/.linuxbrew/bin/brew ]; then
        $HOME/.linuxbrew/bin/brew install $1
    elif [ "$HOMEBREW" = 1 ] || [ -z "${HOMEBREW+x}" ]; then
        install_homebrew "$1" && brew_wrapper $1
    fi
}

{{ if eq .install_package "ask" -}}
if ! dialog_yes_no "Do you want to run the install script"; then
    exit 0
fi
{{ else if eq .install_package "disabled" -}}
exit 0
{{ else if ne .install_package "enabled" -}}
echo "Unrecognized value for \"system_config\""
exit 1
{{ end -}}


{{ if eq .chezmoi.osRelease.id "arch" "manjaro" -}}

# Install AUR package
# ARG : AUR repo link, typically : https://aur.archlinux.org/<package>.git
aur_install() {
    local tmp="${1##https://*/}"
    local package_name="${tmp%.git}"
    if pacman -Q $package_name; then
        return
    else
        git clone "$1" $HOME/.aur_install
        cd $HOME/.aur_install
        makepkg --clean --install --syncdeps
        cd $HOME
        rm -rfd $HOME/.aur_install
    fi
}


#############################################################
# ARCHLINUX - MANJARO
#############################################################

if ! grep --silent "Include = /etc/pacman.d/chaotic-mirrorlist" /etc/pacman.conf; then
    aur_install https://aur.archlinux.org/chaotic-mirrorlist.git
    echo -e "\n[chaotic-aur]\nInclude = /etc/pacman.d/chaotic-mirrorlist\n" | sudo tee -a /etc/pacman.conf
fi

# Install key to enable chaotic-aur repo (https://lonewolf.pedrohlc.com/chaotic-aur/)
sudo pacman-key --keyserver hkp://keyserver.ubuntu.com -r 3056513887B78AEB 8A9E14A07010F7E3
sudo pacman-key --lsign-key 3056513887B78AEB
sudo pacman-key --lsign-key 8A9E14A07010F7E3
pacman -Syyu
pacman -S --needed yay
yay -S --needed ripgrep bash git fd fzf exa fish bat neovim yarn fakeroot binutils ufw htop yay chaotic-keyring starship-bin asdf-vm powerpill


{{ if eq .machine "desktop" -}}
yay -S --needed cups avahi imwheel profile-cleaner profile-sync-daemon pamac-aur meld ungoogled-chromium materia-gtk-theme gnome-tweaks snapd gnome-shell-extension-pop-shell-git pop-shell-shortcuts-git pcmanfm-gtk3 geany gksu ttf-bitstream-vera noto-fonts visual-studio-code-bin bibata-cursor-theme standardnotes-desktop bitwarden-bin insomnia-bin insomnia-designer ttf-twemoji authy-desktop-win32-bin mellowplayer menulibre
{{ end -}}

{{ end -}}


#############################################################
# FEDORA
#############################################################


{{ if eq .chezmoi.osRelease.id "fedora" -}}
sudo dnf update

# Get a more up-to-date fish package
sudo dnf module disable fish
sudo dnf distro-sync fish

sudo dnf install bash git ripgrep fd-find exa fish npm bat neovim python3-neovim bash fzf findutils ufw htop
sudo dnf install starship || curl -fsSL https://starship.rs/install.sh | sudo bash
sudo npm install -g yarn

{{ if eq .machine "desktop" -}}
sudo dnf install 'dnf-command(copr)'
sudo dnf copr enable szasza/Profile-sync-daemon
sudo dnf update
sudo dnf install cups avahi imwheel profile-sync-daemon meld gtkhash
{{ end -}}

{{ end -}}



#############################################################
# DEBIAN - UBUNTU
#############################################################


{{ if eq .chezmoi.osRelease.id "ubuntu" "debian" -}}
sudo apt-get update
sudo apt-get install git bash fish neovim npm curl unzip ufw htop
sudo npm install -g yarn

sudo apt-get install fzf || brew_wrapper fzf && $(/home/linuxbrew/.linuxbrew/bin/brew --prefix)/opt/fzf/install --all --no-zsh --no-bash --64
sudo apt-get install fd-find || brew_wrapper fd
sudo apt-get install exa || brew_wrapper exa
sudo apt-get install ripgrep || brew_wrapper ripgrep
sudo apt-get install bat || brew_wrapper bat
brew_wrapper starship

{{ if eq .machine "desktop" -}}

{{ if eq .chezmoi.osRelease.id "ubuntu" -}}
sudo add-apt-repository ppa:graysky/utils
{{ end -}}

{{ if eq .chezmoi.osRelease.id "debian" -}}
echo "deb http://ppa.launchpad.net/graysky/utils/ubuntu quantal main" > /etc/apt/sources.list.d/graysky.list
echo "deb-src http://ppa.launchpad.net/graysky/utils/ubuntu quantal main" >> /etc/apt/sources.list.d/graysky.list
apt-key adv --keyserver keyserver.ubuntu.com --recv-keys FF7F9516
{{ end -}}

sudo apt-get update
sudo apt-get install cups avahi-daemon imwheel profile-sync-daemon meld gtkhash
sudo apt-get install profile-cleaner

{{ end -}}

{{ end -}}


#############################################################
# OPENSUSE-TUMBLEWEED
#############################################################


{{ if eq .chezmoi.osRelease.id "opensuse-tumbleweed" -}}
sudo zypper update
sudo zypper in bash fish git ripgrep fd exa npm bat neovim fzf ufw htop
sudo npm install -g yarn
curl -fsSL https://starship.rs/install.sh | sudo bash

{{ if eq .machine "desktop" -}}
sudo zypper in cups avahi imwheel meld gtkhash
{{ end -}}

{{ end -}}


#############################################################
# POST INSTALL CONFIGURATION
#############################################################


{{ if ne .chezmoi.osRelease.id "arch" -}}

{{ if ne .chezmoi.osRelease.id "manjaro" -}}
git clone https://github.com/asdf-vm/asdf.git "$HOME"/.asdf
git --git-dir="$HOME"/.asdf/.git checkout $(git --git-dir="$HOME"/.asdf/.git describe --abbrev=0 --tags)
mkdir -p "$HOME"/.config/fish/completions && cp "$HOME"/.asdf/completions/asdf.fish "$HOME"/.config/fish/completions
{{ end -}}

{{ end -}}

yarn config set prefix $HOME/.yarn
yarn global add @fabiospampinato/bump
mkdir -p "$HOME/.local/chezmoi_system"

sudo ufw enable

{{ if eq .machine "desktop" -}}

# Enable auto discovery of printers
sudo systemctl enable --now cups-browsed.service avahi-daemon.service

{{ if eq .chezmoi.osRelease.id "arch" "manjaro" -}}
sudo systemctl enable --now org.cups.cupsd.service
sudo snap install authy --beta
{{ else -}}
sudo systemctl enable --now cups.service

# Set PCManFM as default file manager
xdg-mime default pcmanfm.desktop inode/directory application/x-gnome-saved-search

{{ end -}}

{{ if eq .chezmoi.osRelease.id "arch" "manjaro" -}}
systemctl --user enable profile-cleaner.service profile-cleaner.timer psd.service
{{ end -}}

{{ if eq .chezmoi.osRelease.id "fedora" -}}
systemctl --user enable psd.service
{{ end -}}

{{ end -}}
